# =====================================================
# CYBERSECURITY SEMANTIC MODEL FOR CORTEX ANALYST
# Comprehensive business intelligence layer for security analytics
# =====================================================

semantic_model:
  name: "cybersecurity_analytics"
  description: "Comprehensive cybersecurity analytics semantic model for Cortex Analyst"
  database: "CYBERSECURITY_DEMO"
  schema: "SECURITY_AI"
  
# =====================================================
# DIMENSIONS - Business Entities
# =====================================================

dimensions:
  
  # Time Dimensions
  - name: "time"
    type: "time"
    description: "Time-based analysis for security events"
    expr: "timestamp"
    time_formats: ["YYYY-MM-DD", "YYYY-MM-DD HH24:MI:SS"]
    
  - name: "date"
    type: "time"
    description: "Date for daily security analytics"
    expr: "DATE(timestamp)"
    
  # Security Incident Dimensions
  - name: "incident_severity"
    type: "categorical"
    description: "Security incident severity levels"
    expr: "severity"
    values: ["critical", "high", "medium", "low"]
    
  - name: "incident_type"
    type: "categorical"
    description: "Types of security incidents"
    expr: "incident_type"
    values: ["malware", "data_exfiltration", "suspicious_login", "brute_force", "phishing"]
    
  - name: "incident_status"
    type: "categorical"
    description: "Current status of security incidents"
    expr: "status"
    values: ["open", "investigating", "resolved", "closed"]
    
  # User and Authentication Dimensions
  - name: "username"
    type: "categorical"
    description: "User identities for authentication analysis"
    expr: "username"
    
  - name: "user_department"
    type: "categorical"
    description: "User organizational department"
    expr: "department"
    values: ["IT", "Finance", "HR", "Engineering", "Sales", "Marketing", "Security"]
    
  - name: "login_country"
    type: "categorical"
    description: "Geographic location of user logins"
    expr: "location:country::STRING"
    
  - name: "security_clearance"
    type: "categorical"
    description: "User security clearance level"
    expr: "security_clearance"
    values: ["Standard", "Confidential", "Secret", "Top Secret"]
    
  # Risk Assessment Dimensions
  - name: "risk_level"
    type: "categorical"
    description: "ML-computed risk assessment levels"
    expr: "risk_level"
    values: ["CRITICAL", "HIGH", "MEDIUM", "LOW"]
    
  - name: "anomaly_type"
    type: "categorical"
    description: "Type of behavioral anomaly detected"
    expr: "model_agreement"
    values: ["BOTH_AGREE_ANOMALY", "BOTH_AGREE_NORMAL", "NATIVE_ONLY", "SNOWPARK_ONLY"]
    
  - name: "user_cluster"
    type: "categorical"
    description: "ML-based user behavioral clusters"
    expr: "cluster_label"
    values: ["BUSINESS_HOURS_REGULAR", "INTERNATIONAL_ACCESS", "WEEKEND_WORKER", "OFF_HOURS_FREQUENT", "MULTI_LOCATION_USER", "HIGH_ACTIVITY_USER"]
    
  # Vulnerability Dimensions
  - name: "cve_severity"
    type: "categorical"
    description: "CVE vulnerability severity classification"
    expr: "severity"
    values: ["critical", "high", "medium", "low"]
    
  - name: "asset_type"
    type: "categorical"
    description: "Type of assets affected by vulnerabilities"
    expr: "CASE WHEN asset_name LIKE '%server%' THEN 'Server' WHEN asset_name LIKE '%laptop%' THEN 'Endpoint' WHEN asset_name LIKE '%database%' THEN 'Database' ELSE 'Other' END"
    values: ["Server", "Database", "Endpoint", "Network", "Other"]
    
  - name: "vulnerability_status"
    type: "categorical"
    description: "Current vulnerability remediation status"
    expr: "status"
    values: ["open", "patched", "mitigated", "accepted_risk"]
    
  # Threat Intelligence Dimensions
  - name: "threat_type"
    type: "categorical"
    description: "Type of threat from intelligence feeds"
    expr: "threat_type"
    values: ["apt", "malware", "botnet", "phishing", "ransomware"]
    
  - name: "threat_severity"
    type: "categorical"
    description: "Threat intelligence severity rating"
    expr: "severity"
    values: ["critical", "high", "medium", "low"]
    
  - name: "threat_source"
    type: "categorical"
    description: "Source of threat intelligence"
    expr: "source_type"
    values: ["government_feed", "commercial_feed", "open_source", "internal"]

# =====================================================
# MEASURES - Key Metrics
# =====================================================

measures:
  
  # Incident Metrics
  - name: "total_incidents"
    type: "count"
    description: "Total number of security incidents"
    expr: "COUNT(*)"
    
  - name: "critical_incidents"
    type: "count"
    description: "Number of critical severity incidents"
    expr: "COUNT(CASE WHEN severity = 'critical' THEN 1 END)"
    
  - name: "open_incidents"
    type: "count"
    description: "Number of currently open incidents"
    expr: "COUNT(CASE WHEN status = 'open' THEN 1 END)"
    
  - name: "avg_incident_resolution_time"
    type: "number"
    description: "Average time to resolve incidents (hours)"
    expr: "AVG(CASE WHEN status = 'resolved' THEN DATEDIFF(hour, created_at, resolved_at) END)"
    
  - name: "incident_trend"
    type: "number"
    description: "Incident count trend over time"
    expr: "COUNT(*)"
    
  # Authentication and User Metrics
  - name: "total_logins"
    type: "count"
    description: "Total number of user authentication attempts"
    expr: "COUNT(*)"
    
  - name: "failed_logins"
    type: "count"
    description: "Number of failed authentication attempts"
    expr: "COUNT(CASE WHEN success = FALSE THEN 1 END)"
    
  - name: "login_success_rate"
    type: "percentage"
    description: "Percentage of successful login attempts"
    expr: "AVG(CASE WHEN success THEN 1.0 ELSE 0.0 END) * 100"
    
  - name: "unique_users"
    type: "count_distinct"
    description: "Number of unique users"
    expr: "COUNT(DISTINCT username)"
    
  - name: "foreign_login_attempts"
    type: "count"
    description: "Login attempts from foreign countries"
    expr: "COUNT(CASE WHEN location:country::STRING NOT IN ('US', 'United States') THEN 1 END)"
    
  # Risk and Anomaly Metrics
  - name: "total_anomalies"
    type: "count"
    description: "Total ML-detected behavioral anomalies"
    expr: "COUNT(*)"
    
  - name: "critical_risk_users"
    type: "count"
    description: "Users with critical risk assessment"
    expr: "COUNT(CASE WHEN risk_level = 'CRITICAL' THEN 1 END)"
    
  - name: "avg_anomaly_score"
    type: "number"
    description: "Average ML anomaly score"
    expr: "AVG(ABS(snowpark_score))"
    
  - name: "model_agreement_rate"
    type: "percentage"
    description: "Percentage where ML models agree on anomalies"
    expr: "AVG(CASE WHEN model_agreement = 'BOTH_AGREE_ANOMALY' THEN 1.0 ELSE 0.0 END) * 100"
    
  # Vulnerability Metrics
  - name: "total_vulnerabilities"
    type: "count"
    description: "Total number of vulnerabilities"
    expr: "COUNT(*)"
    
  - name: "critical_vulnerabilities"
    type: "count"
    description: "Critical CVSS 9+ vulnerabilities"
    expr: "COUNT(CASE WHEN cvss_score >= 9.0 THEN 1 END)"
    
  - name: "open_vulnerabilities"
    type: "count"
    description: "Currently unpatched vulnerabilities"
    expr: "COUNT(CASE WHEN status = 'open' THEN 1 END)"
    
  - name: "avg_cvss_score"
    type: "number"
    description: "Average CVSS vulnerability score"
    expr: "AVG(cvss_score)"
    
  - name: "vulnerability_age_days"
    type: "number"
    description: "Average age of open vulnerabilities (days)"
    expr: "AVG(CASE WHEN status = 'open' THEN DATEDIFF(day, first_detected, CURRENT_DATE()) END)"
    
  # Threat Intelligence Metrics
  - name: "total_threats"
    type: "count"
    description: "Total threat intelligence indicators"
    expr: "COUNT(*)"
    
  - name: "high_confidence_threats"
    type: "count"
    description: "High confidence threat indicators"
    expr: "COUNT(CASE WHEN confidence_score >= 0.8 THEN 1 END)"
    
  - name: "avg_threat_confidence"
    type: "percentage"
    description: "Average threat intelligence confidence"
    expr: "AVG(confidence_score) * 100"

# =====================================================
# TABLES - Physical Data Sources
# =====================================================

tables:
  
  - name: "security_incidents"
    description: "Security incident records and details"
    table: "SECURITY_INCIDENTS"
    dimensions: ["time", "incident_severity", "incident_type", "incident_status"]
    measures: ["total_incidents", "critical_incidents", "open_incidents", "avg_incident_resolution_time"]
    
  - name: "user_authentication"
    description: "User login and authentication events"
    table: "USER_AUTHENTICATION_LOGS"
    dimensions: ["time", "username", "login_country", "user_department", "security_clearance"]
    measures: ["total_logins", "failed_logins", "login_success_rate", "unique_users", "foreign_login_attempts"]
    
  - name: "employee_directory"
    description: "Employee and user profile information"
    table: "EMPLOYEE_DATA"
    dimensions: ["username", "user_department", "security_clearance"]
    measures: ["unique_users"]
    
  - name: "ml_anomaly_detection"
    description: "Machine learning anomaly detection results"
    table: "ML_MODEL_COMPARISON"
    dimensions: ["date", "username", "risk_level", "anomaly_type", "user_cluster"]
    measures: ["total_anomalies", "critical_risk_users", "avg_anomaly_score", "model_agreement_rate"]
    
  - name: "vulnerability_management"
    description: "Vulnerability scan results and management"
    table: "VULNERABILITY_SCANS"
    dimensions: ["date", "cve_severity", "asset_type", "vulnerability_status"]
    measures: ["total_vulnerabilities", "critical_vulnerabilities", "open_vulnerabilities", "avg_cvss_score", "vulnerability_age_days"]
    
  - name: "threat_intelligence"
    description: "External threat intelligence feeds"
    table: "THREAT_INTEL_FEED"
    dimensions: ["threat_type", "threat_severity", "threat_source"]
    measures: ["total_threats", "high_confidence_threats", "avg_threat_confidence"]

# =====================================================
# RELATIONSHIPS - Table Joins
# =====================================================

relationships:
  
  - name: "user_auth_to_employee"
    type: "many_to_one"
    from_table: "user_authentication"
    from_column: "username"
    to_table: "employee_directory"
    to_column: "username"
    
  - name: "ml_anomalies_to_employee"
    type: "many_to_one"
    from_table: "ml_anomaly_detection"
    from_column: "username"
    to_table: "employee_directory"
    to_column: "username"
    
  - name: "incidents_to_time"
    type: "many_to_one"
    from_table: "security_incidents"
    from_column: "created_at"
    to_table: "user_authentication"
    to_column: "timestamp"
    description: "Time-based correlation between incidents and authentication events"

# =====================================================
# BUSINESS DEFINITIONS - Synonyms and Context
# =====================================================

synonyms:
  
  # Incident synonyms
  - terms: ["incidents", "security events", "alerts", "breaches"]
    maps_to: "security_incidents"
    
  - terms: ["critical", "high priority", "urgent", "severe"]
    maps_to: "incident_severity = 'critical'"
    
  - terms: ["malware", "virus", "trojan", "ransomware"]
    maps_to: "incident_type = 'malware'"
    
  # User and authentication synonyms
  - terms: ["users", "employees", "accounts", "identities"]
    maps_to: "username"
    
  - terms: ["logins", "authentication", "sign-ins", "access attempts"]
    maps_to: "user_authentication"
    
  - terms: ["failed logins", "login failures", "authentication failures"]
    maps_to: "failed_logins"
    
  # Risk and anomaly synonyms
  - terms: ["anomalies", "unusual behavior", "outliers", "suspicious activity"]
    maps_to: "ml_anomaly_detection"
    
  - terms: ["high risk", "critical risk", "dangerous users"]
    maps_to: "risk_level = 'CRITICAL'"
    
  - terms: ["insider threats", "internal threats", "employee risks"]
    maps_to: "ml_anomaly_detection WHERE risk_level IN ('CRITICAL', 'HIGH')"
    
  # Vulnerability synonyms
  - terms: ["vulnerabilities", "security flaws", "weaknesses", "CVEs"]
    maps_to: "vulnerability_management"
    
  - terms: ["unpatched", "open vulnerabilities", "pending fixes"]
    maps_to: "vulnerability_status = 'open'"
    
  # Threat intelligence synonyms
  - terms: ["threats", "threat intel", "IOCs", "indicators"]
    maps_to: "threat_intelligence"
    
  - terms: ["APT", "advanced persistent threat", "nation state"]
    maps_to: "threat_type = 'apt'"

# =====================================================
# EXAMPLE QUERIES - Business Questions
# =====================================================

example_queries:
  - question: "How many critical incidents do we have this week?"
    description: "Count of critical severity incidents in the last 7 days"
    
  - question: "Which users have the highest risk scores?"
    description: "Users with CRITICAL or HIGH risk levels from ML analysis"
    
  - question: "What are our top vulnerability priorities?"
    description: "Open vulnerabilities ordered by CVSS score and criticality"
    
  - question: "Show me login trends by department"
    description: "Authentication volume trends segmented by user department"
    
  - question: "What threat types are we seeing most?"
    description: "Threat intelligence indicators grouped by threat type"
    
  - question: "How is our security posture trending?"
    description: "Security metrics trends over time (incidents, anomalies, vulnerabilities)"
    
  - question: "Which countries have suspicious login activity?"
    description: "Foreign login attempts and failed authentication by country"
    
  - question: "What's our vulnerability remediation performance?"
    description: "Vulnerability age and patching metrics by severity"
